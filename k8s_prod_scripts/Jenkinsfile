pipeline {
    agent any

    environment {
        K8S_NAMESPACE = 'springapp-ns'
        APP_NAME = 'spring-app'
        DB_NAME = 'mysql-db'
        APP_IMAGE = 'sakit333/webapp_dev:latest'
        DB_IMAGE = 'mysql:8.0'
        APP_PORT = '8088'
        NODE_PORT = '30088'
        DB_PASSWORD = '1234'
        DB_NAME_MYSQL = 'myapplication'
        KUBE_PROJECT_DIR = 'k8s_prod_scripts'
        //  Kubeconfig path directly on Jenkins server
        KUBECONFIG = '/home/jenkins/kubeconfig_for_jenkins/kubeconfig.yaml'
    }

    parameters {
        choice(name: 'ACTION', choices: ['deploy', 'remove'], description: 'Choose to deploy or remove resources')
        // booleanParam(name: 'DEPLOY_APP', defaultValue: true, description: 'Deploy Spring Boot app?')
    }

    stages {

        stage('Verify Kubernetes Access') {
            steps {
                sh '''
                    echo "Verifying access to Kubernetes cluster..."
                    kubectl config view
                    kubectl get nodes
                '''
            }
        }

        stage('Create Namespace') {
            when {
                expression { params.ACTION == 'deploy' }
            }
            steps {
                sh '''
                    if ! kubectl get namespace $K8S_NAMESPACE >/dev/null 2>&1; then
                        kubectl apply -f $KUBE_PROJECT_DIR/namespace.yml
                        echo "Namespace created."
                    else
                        echo "Namespace already exists, skipping..."
                    fi
                '''
            }
        }

        stage('Deploy MySQL') {
            when {
                expression { params.ACTION == 'deploy' }
            }
            steps {
                sh 'kubectl apply -f $KUBE_PROJECT_DIR/db_deploy_svc.yml -n $K8S_NAMESPACE'
            }
        }

        stage('Wait for MySQL Ready') {
            when {
                allOf {
                    expression { params.ACTION == 'deploy' }
                    // expression { params.DEPLOY_APP == true }
                }
            }
            steps {
                sh '''
                    echo "Waiting for MySQL pod to be ready..."
                    kubectl wait --for=condition=ready pod -l app=$DB_NAME -n $K8S_NAMESPACE --timeout=180s
                '''
            }
        }

        stage('Deploy Spring Boot App') {
            when {
                allOf {
                    expression { params.ACTION == 'deploy' }
                    // expression { params.DEPLOY_APP == true }
                }
            }
            steps {
                sh 'kubectl apply -f $KUBE_PROJECT_DIR/app_deploy_svc.yml -n $K8S_NAMESPACE'
            }
        }

        stage('Show Resources') {
            when {
                expression { params.ACTION == 'deploy' }
            }
            steps {
                sh 'kubectl get all -n $K8S_NAMESPACE'
            }
        }

        stage('Remove Spring Boot App') {
            when {
                allOf {
                    expression { params.ACTION == 'remove' }
                    // expression { params.DEPLOY_APP == true }
                }
            }
            steps {
                sh 'kubectl delete -f $KUBE_PROJECT_DIR/app_deploy_svc.yml -n $K8S_NAMESPACE || true'
            }
        }

        stage('Remove MySQL') {
            when {
                expression { params.ACTION == 'remove' }
            }
            steps {
                sh 'kubectl delete -f $KUBE_PROJECT_DIR/db_deploy_svc.yml -n $K8S_NAMESPACE || true'
            }
        }

        stage('Remove Namespace') {
            when {
                expression { params.ACTION == 'remove' }
            }
            steps {
                sh 'kubectl delete -f $KUBE_PROJECT_DIR/namespace.yml || true'
            }
        }

        stage('Show Resources After Removal') {
            when {
                expression { params.ACTION == 'remove' }
            }
            steps {
                sh 'kubectl get all -n $K8S_NAMESPACE || echo "Namespace deleted."'
            }
        }
    }

    post {
        always {
            echo "âœ… Pipeline execution completed."
        }
    }
}
